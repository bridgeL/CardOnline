# 总述

为保证消息的正确传递，需要在服务器端和客户端设置一种约定——消息协议，要求其可以封装游戏中需要传递的所有种类的消息

第一版设计是基于局域网的Socket连接方式进行通讯，之后的版本再考虑升级到https或ssh等方式

## 结构设计

### 服务器端，应当包括以下模块的设计

1. 通讯模块
2. 游戏大厅模块
3. 表情模块
4. 卡牌模块

### 客户端，应当包括以下模块的设计

1. 通讯模块
2. 游戏大厅模块
3. 表情模块
4. 卡牌模块
5. 多层次图形化界面模块

### 服务器端运行架构

#### 游戏大厅模式

- 通讯模块 - 开启连接 - 单独开启一个线程负责监听新的连接请求，并将他们加入到设备列表里，并分配设备号
- 循环等待消息 - 游戏大厅模块 - 捕获到消息后，经过分类器函数辨识，交由不同的函数处理
  - 捕获到注册请求 - 处理注册昵称函数
  - 捕获到座位请求 - 处理座位函数
  - 捕获到开始游戏请求 - 处理游戏开始函数
    - 如果成功，则结束本模式下的所有的临时变量、线程，跳出循环，进入下一个模式

#### 游戏模式

- 循环等待消息
  - 接收到表情消息 - 丢给表情模块
  - 接收到卡牌消息 - 丢给卡牌模块 - 丢给分类器
    - 接收到犯人出逃成功、侦探指认成功等处理结果后，跳出循环，进入下一个模式

#### 游戏结束模式

- 游戏大厅模块 - 处理游戏结算函数



### 客户端运行架构

#### 游戏大厅模式

- 通讯模块 - 建立连接
- 循环等待消息 或 键鼠触发 
  - 非等待批复状态
    - 键鼠触发 
      - 游戏大厅模块 - 提交注册昵称请求函数 - 进入等待批复状态
      - 游戏大厅模块 - 提交座位坐下/站立请求函数 - 进入等待批复状态
      - 游戏大厅模块 - 提交游戏开始请求函数 - 进入等待批复状态
    - 非键鼠触发，服务器端主动发送
      - 游戏大厅模块 - 被告知他人的注册昵称请求函数
      - 游戏大厅模块 - 被告知他人的座位坐下/站立请求函数
      - 游戏大厅模块 - 被告知他人的游戏开始请求函数
  - 等待批复状态
    - 根据提交请求函数，执行相应的批复函数
  - 无论如何，如果开始游戏成功，则结束本模式下的所有的临时变量、线程，跳出循环，进入下一个模式

#### 游戏模式

- 循环等待消息 或 键鼠触发 
  - 非等待批复状态
    - 键鼠触发 
      - 表情模块 - 提交请求消息 - 进入等待批复状态
      - 卡牌模块 - 丢给分类器 - 提交请求消息 - 进入等待批复状态
    - 非键鼠触发，服务器端主动发送
      - 接收到表情消息 - 丢给表情模块 - 被告知函数
      - 接收到卡牌消息 - 丢给卡牌模块 - 丢给分类器 - 被告知函数
  - 等待批复状态
    - 根据提交请求函数，执行相应的批复函数
  - 无论如何，如果接收到犯人出逃成功、侦探指认成功等处理结果后，跳出循环，进入下一个模式

#### 游戏结束模式

- 游戏大厅模块 - 处理游戏结算函数



## 激励模式

经分析，服务器端是单激励单输出，即客户端发送消息，服务器端经过加工处理，答复消息；客户端是双激励双输出，一是用户对图形化界面进行键鼠操作，激励客户端做出相应处理，发送消息至服务器端，二是服务器端发送应答消息（此消息可能是本地客户端激发的，也可能是其他客户端激发的）至客户端，激励客户端做出响应，输出改变至图形化界面。

| 类别     | 路径                                                      |
| -------- | --------------------------------------------------------- |
| 服务器端 | 客户端 -> 服务器端 -> 客户端 / 其他客户端                 |
| 客户端   | 键鼠操作 -> 客户端 -> 服务器端 -> 客户端 -> 图形化界面    |
| 客户端   | 其他客户端- - - - - - -> 服务器端 -> 客户端 -> 图形化界面 |

术语：

服务器端由于上述第一条激励路径，对客户端发送消息的行为，本项目中通常称为通知、处理请求、应答（Answer）；客户端通过上述第二条激励路径，对服务器端发送消息的行为通常称为请求（Require），接收服务器端应答消息的行为，通常称为等待批复（Wait）；客户端通过上述第三条激励路径，接收服务器端应答消息的行为，通常称为被告知（Told）.



## 消息协议

通过定义游戏消息类，封装各类消息

### 游戏消息类

| 成员类型 | 作用                        |
| -------- | --------------------------- |
| char     | 寄信人设备号                |
| char     | 收信人设备号                |
| char     | 消息类型                    |
| char     | 消息字节数                  |
| char[]   | 消息数组（仅允许英文/数字） |

### 设备号

客户端的设备号，在其与服务器端建立连接时，由服务器端分配告知，此时的协议较为低级

游戏运行时，协议升级为传递游戏消息类定义消息对象

服务器端的设备号为0

### 消息类型

客户端发送的消息

| 值  | 含义                                             | 消息长度 |
| --- | ------------------------------------------------ | -------- |
| 1   | 请求 以 xx 的昵称登录游戏                        | ？       |
| 2   | 请求 在x号座位 坐下/站立                         | 2        |
| 4   | 请求 开始游戏（仅允许坐在1号位的玩家执行此操作） | 1        |
| 5   | 请求 发送 表情x                                  | 1        |
| 7   | 请求 摸牌                                        | 1        |
| 8   | 请求 打出 牌x （并且指定了1-2位用户）            | 1（+2）  |
| 9   | 请求 抽取 用户yy  一张手牌                       | 1        |
| 10  | 请求 传给 用户yy 牌x                             | 2        |
| 11  | 请求 查看 用户yy 的所有手牌                      | 1        |
 
服务器端发送的消息

| 值  | 含义                                                  | 消息长度 |
| --- | ----------------------------------------------------- | -------- |
| -1  | 通知 所有人 有 设备号为x， 昵称为xx 的新用户登入房间  | 1 + ？   |
| -2  | 通知 用户xx 可以/不可以 在x号座位 坐下/站立           | 1        |
| -3  | 通知 所有人 用户xx 在x号座位 坐下/站立                | 2        |
| -4  | 通知 所有人 游戏开始/人数未满/没有开始游戏的权限      | 1        |
| -5  | 通知 所有人 用户xx 发送了 表情x                       | 2        |
| -6  | 通知 用户xx 摸到了 牌x                                | 1        |
| -7  | 通知 所有人 用户xx 摸了一张牌                         | 1        |
| -8  | 通知 所有人 用户xx 打出了 牌x （并且指定了1-2位用户） | 1（+2）  |
| -9  | 通知 所有人 用户xx 得到了 用户yy 一张牌               | 2        |
| -10 | 通知 用户xx 得到了 用户yy 的 一张牌x                  | 2        |
| -11 | 通知 用户xx 用户yy（也可以是自己） 的所有手牌         | 1 + ？   |
| -12 | 通知 所有人 目前应当由 用户yy 出牌/抽牌/传递牌        | 2        |
| -13 | 通知 所有人 游戏结束，用户yy 作为 身份y 胜出/失败...  | 3 * ？   |

### 消息字节数

标识了接下来消息数组的长度

### 消息数组

存放了一系列数字或英文，用于传递消息号、文字信息等



## 服务器端

服务器端应准备的模块

### 通讯模块

实现对客户端和服务端连接的封装

#### 消息缓存队列

存储了各个设备发送给服务器端的，尚未处理的消息，先入先出

#### 设备列表

存储与此服务器端成功建立起连接的客户端的设备地址，并为其分配一个设备号

分配的设备号，通过底层发送函数告知客户端

#### 连接函数

| 方向 | 类型 | 作用                                                                   |
| ---- | ---- | ---------------------------------------------------------------------- |
| void | void | 等待客户端连接，在成功建立连接后，将设备地址存入设备列表，并分配设备号 |

#### 底层发送函数（阻塞式）

|     | 方向 | 类型 | 作用 |  |
| --- | ---- | ---- |----- -- | ----- -------- |-- |
| | INPUT | Bytes | 字节数组 | |

#### 底层接收函数（阻塞式）

接收超时后自动退出

|     | 方向 | 类型 | 作用 |  |
| --- | ---- | ---- |----- --- | ---- -------- |--- |
| | OUTPUT | Bytes | 字节数组 | |

#### 高层次发送函数（阻塞式）

|     | 方向 | 类型 | 作用 |  |
| --- | ---- | ---- |------- ---- | ------------ ------------------------ |----------- |
| | INPUT | GAMEMSG | 已经封装好的游戏消息对象 | |

#### 高层次接收函数（非阻塞式，多线程，持续监听）

|     | 方向 | 类型 | 作用 |  |
| --- | ---- | ---- |------- ----- | ------------ ------------------------ |----------- |
| | OUTPUT  | GAMEMSG | 已经封装好的游戏消息对象 | |

直接将消息发送到消息缓存队列中



### 游戏大厅模块

实现了登入昵称的注册，以及座位的分配

#### 昵称列表

存储了目前大厅内所有注册过昵称的设备的 <设备号,昵称>

#### 座位列表

存储每个座位目前坐下的用户的设备号，0代表空座

#### 阵营列表

存储所有参与游戏的用户的 <设备号，阵营>，需要在游戏开始的时候初始化

#### 当前玩家的设备号

存储目前轮到谁出牌/抽牌/传递牌

#### 分类器

捕获到消息后，经过分类器函数辨识，交由不同的函数处理

#### 处理注册昵称函数

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型1  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-1 |

#### 处理座位函数

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型2  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-2 |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-3 |

#### 处理游戏开始函数

| 方向   | 类型            | 作用                    |
| ------ | --------------- | ----------------------- |
| INPUT  | GAMEMSG         | 游戏消息类，消息类型4   |
| OUTPUT | GAMEMSG         | 游戏消息类，消息类型-4  |
| OUTPUT | GAMEMSG[玩家数] | 游戏消息类，消息类型-11 |
| OUTPUT | GAMEMSG         | 游戏消息类，消息类型-12 |

#### 处理游戏结算函数
| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-13 |



### 表情模块

服务器端无需存储任何表情文件，表情文件存储在客户端本体

服务器端只负责通知客户端展示表情，并对频繁发送表情的行为作出限制

#### 处理表情函数

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型5  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-5 |



### 卡牌模块

服务器端无需存储任何卡牌文件，卡牌文件存储在客户端本体

服务器端只负责通知客户端展示卡牌的转移情况，并对特殊卡牌实现其效果

#### 分类器函数

对接收到的出牌消息进行分类，调用对应的卡牌处理函数，并在处理后告知所有人目前轮到谁出牌/抽牌/传递牌

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型8   |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-12 |

#### 处理普通人/不在场证明/第一发现人函数

|     |     |  |  |  |  |  |  |  | 方向 | 类型 | 作用 |  |  |  |  |  |  |  |  |  |
| --- | --- || | | | | | | ---- --- ----- ----- ----- ----- ----- ----- ----- ----- | ---- ----        --- -- ------ ------ ------ ------ ------ ------ ------ ------ | --------------- --------------- ---------------------- ---------------------- ---------------------- ---------------------- ---------------------- ---------------------- ---------------------- ----------------------------- |------ | | | | | | | | |
| | | | | | | | | | INPUT           | GAMEMSG | 游戏消息类，消息类型8  |  |   |   |   |   |   |   |   |   |
| | | | | | | | | | OUTPUT          | GAMEMSG | 游戏消息类，消息类型-8 | |  |  |  |  |  |  |  |  |
| | | | | | | | OUTPUT        | GAMEMSG | 游戏消息类，消息类型-12 | | | | | | | |

#### 处理共犯函数

变更阵营

| | | | | | | | | 方向                   | 类型                            | 作用                               |     |                  |                  |                  |                  |                  |                  |                  |
| --| --| | | | | | | ---- --- ----- ----- ----- ----- ----- ----- ----- | ---- ----       --- -- ------ ------ ------ ------ ------ ------ ------ | --------------- --------------- ---------------------- ---------------------- ---------------------- ---------------------- ---------------------- ---------------------- ----------------------------- |------ | | | | | | | |
| | | | | | | | | INPUT          | GAMEMSG | 游戏消息类，消息类型8  |  |   |   |   |   |   |   |   |
| | | | | | | | | OUTPUT         | GAMEMSG | 游戏消息类，消息类型-8 | |  |  |  |  |  |  |  |
| | | | | | | OUTPUT       | GAMEMSG | 游戏消息类，消息类型-12 | | | | | | |

#### 处理交易函数

开启状态机（内置静态变量），不同状态机下，函数输出不同

需要暂存当前出牌的人

0状态：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

1状态、2状态：

| | 方向     | 类型       | 作用                                    |  |
| | ------ ----- | ------ -------  | -- ----------------------- |-------------------- |
| | INPUT   | GAMEMSG | 游戏消息类，消息类型10  |  |
| | OUTPUT  | GAMEMSG | 游戏消息类，消息类型-10 | |
| | OUTPUT  | GAMEMSG | 游戏消息类，消息类型-9  |  |
| | OUTPUT  | GAMEMSG | 游戏消息类，消息类型-12 | |

#### 处理谣言函数

开启状态机（内置静态变量），不同状态机下，函数输出不同

0状态：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

1-4状态：

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型9   |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-10 |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-9  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-12 |

#### 处理情报交换函数

开启状态机（内置静态变量），不同状态机下，函数输出不同

0状态：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

1-4状态：

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型10  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-10 |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-9  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-12 |

#### 处理目击者函数

开启状态机（内置静态变量），不同状态机下，函数输出不同

需要暂存当前出牌的人

0状态：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

1状态：

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型11  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-11 |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-12 |

#### 处理犯人函数

根据手牌数判断，是否可以打出

若成功打出，则变换阵营，并开始游戏结算

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8

#### 处理侦探函数

根据手牌数判断，是否可以打出

若成功打出，判断是否指认成功（这取决于犯人卡和不在场证明卡），若成功，则变换阵容，并开始游戏结算，否则无效果

指认成功：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8

指认失败：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

#### 处理神犬函数

开启状态机（内置静态变量），不同状态机下，函数输出不同

需要暂存当前出牌的人

0状态：

方向 | 类型 | 作用  
-|-|-
INPUT | GAMEMSG | 游戏消息类，消息类型8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-8
OUTPUT| GAMEMSG | 游戏消息类，消息类型-12

1状态：

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| INPUT  | GAMEMSG | 游戏消息类，消息类型8   |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-8  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-10 |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-9  |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型-12 |



## 客户端

客户端应准备的模块

### 通讯模块

实现对客户端和服务端连接的封装

#### 消息缓存队列

存储了服务器端发送给客户端的，尚未处理的消息，先入先出

#### 设备号

存储了服务器端分配给客户端的设备号

#### 连接函数（阻塞式）

超时后退出

| 方向 | 类型 | 作用                                                 |
| ---- | ---- | ---------------------------------------------------- |
| void | void | 尝试连接服务器端，在成功建立连接后，存储分配的设备号 |

#### 底层发送函数（阻塞式）

| 方向  | 类型  | 作用     |
| ----- | ----- | -------- |
| INPUT | Bytes | 字节数组 |

#### 底层接收函数（阻塞式）

接收超时后自动退出

| 方向   | 类型  | 作用     |
| ------ | ----- | -------- |
| OUTPUT | Bytes | 字节数组 |

#### 高层次发送函数（阻塞式）

| 方向  | 类型    | 作用                     |
| ----- | ------- | ------------------------ |
| INPUT | GAMEMSG | 已经封装好的游戏消息对象 |

#### 高层次接收函数（非阻塞式，多线程，持续监听）

| 方向   | 类型    | 作用                     |
| ------ | ------- | ------------------------ |
| OUTPUT | GAMEMSG | 已经封装好的游戏消息对象 |

直接将消息发送到消息缓存队列中



### 游戏大厅模块

实现了登入昵称的注册，以及在座位上坐下/站起，这里需要编写图形化界面，读取鼠标、键盘信息

#### 昵称列表

存储了目前大厅内所有注册过昵称的设备的 <设备号,昵称>

#### 个人昵称

存储了自己注册的昵称，默认为无

#### 座位列表

存储每个座位目前坐下的用户的设备号，0代表空座

#### 当前玩家的设备号

存储目前轮到谁出牌/抽牌/传递牌

#### 当前玩家的阵营

存储目前自己所处的阵营

#### 提交注册昵称请求函数

提交请求，并等待服务器端批准/拒绝，需要编写图形化界面，读取鼠标、键盘信息

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型1  |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-1 |

#### 被告知他人的注册昵称请求函数

需要编写图形化界面，修改屏幕显示

| 方向  | 类型    | 作用                   |
| ----- | ------- | ---------------------- |
| INPUT | GAMEMSG | 游戏消息类，消息类型-1 |


#### 提交座位坐下/站立请求函数

提交请求，并等待服务器端批准/拒绝，需要编写图形化界面，读取鼠标、键盘信息

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型2  |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-2 |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-3 |

#### 被告知他人的座位坐下/站立请求函数

需要编写图形化界面，修改画面

| 方向  | 类型    | 作用                   |
| ----- | ------- | ---------------------- |
| INPUT | GAMEMSG | 游戏消息类，消息类型-3 |

#### 提交游戏开始请求函数

提交请求，并等待服务器端批准/拒绝，需要编写图形化界面，读取鼠标、键盘信息

| 方向   | 类型    | 作用                    |
| ------ | ------- | ----------------------- |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型4   |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-4  |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-11 |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-12 |

#### 被告知他人的游戏开始请求函数

需要编写图形化界面，修改画面

| 方向  | 类型    | 作用                    |
| ----- | ------- | ----------------------- |
| INPUT | GAMEMSG | 游戏消息类，消息类型-4  |
| INPUT | GAMEMSG | 游戏消息类，消息类型-11 |
| INPUT | GAMEMSG | 游戏消息类，消息类型-12 |

#### 处理游戏结束函数

需要编写图形化界面，修改画面

| 方向  | 类型    | 作用                    |
| ----- | ------- | ----------------------- |
| INPUT | GAMEMSG | 游戏消息类，消息类型-13 |



### 表情模块

服务器端没有存储任何表情文件，表情文件存储在客户端本体

服务器端只负责通知客户端表情编号，客户端负责寻找，并显示该表情

#### 提交表情请求函数

| 方向   | 类型    | 作用                   |
| ------ | ------- | ---------------------- |
| OUTPUT | GAMEMSG | 游戏消息类，消息类型5  |
| INPUT  | GAMEMSG | 游戏消息类，消息类型-5 |

#### 被告知他人的表情请求函数

| 方向  | 类型    | 作用                   |
| ----- | ------- | ---------------------- |
| INPUT | GAMEMSG | 游戏消息类，消息类型-5 |



### 卡牌模块

服务器端不存储任何卡牌文件，卡牌文件存储在客户端本体

服务器端只负责通知客户端展示卡牌的转移情况，客户端需要自行根据数据调用修改图形资源

#### 分类器函数

对接收到的出牌消息进行分类，调用对应的卡牌处理函数

.....




### 多层次图形化处理模块

负责将键鼠的操作抽象化，例如，实现输入英文，点击展开覆盖层列表，选中、移动卡片等效果
